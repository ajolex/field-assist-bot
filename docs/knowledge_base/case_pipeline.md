# Case Pipeline — End-to-End Technical Documentation

> This document describes the complete technical workflow for how cases move from
> assignment to upload to closure. It is intended for the bot to understand the
> system architecture and for the SRA as a reference.

---

## Pipeline Overview

```
┌──────────────────┐     ┌──────────────┐     ┌──────────────────┐     ┌─────────────┐
│ 1. Assignment     │────▶│ 2. Stata      │────▶│ 3. SurveyCTO     │────▶│ 4. Field     │
│    Spreadsheet    │     │    Processing │     │    Server Upload  │     │    Collection│
│ (FM: Eunice)      │     │ (SRA: Aubrey) │     │ (SRA: Aubrey)    │     │ (FOs)        │
└──────────────────┘     └──────────────┘     └──────────────────┘     └──────┬──────┘
                                                                               │
                                                                               ▼
┌──────────────────┐     ┌──────────────┐     ┌──────────────────┐     ┌─────────────┐
│ 7. Data Quality   │◀────│ 6. Stata      │◀────│ 5. Data          │◀────│ Auto-close   │
│    Checks (HFCs) │     │    Cleaning   │     │    Download      │     │ via formula  │
│ (SRA: Aubrey)     │     │ (SRA: Aubrey) │     │ (SRA: Aubrey)    │     │ (SurveyCTO)  │
└──────────────────┘     └──────────────┘     └──────────────────┘     └─────────────┘
```

---

## Step 1: Team-to-Barangay Assignment

**Who**: Field Manager (Eunice)
**Where**: [ICM Follow-up Prep & Survey Plan](https://docs.google.com/spreadsheets/d/1KKtZRSFAd-kIfY0pUObgu3wylt80B9tcis7medSlM7s/edit?gid=1809436197#gid=1809436197)
**What**: Assigns teams to barangays with deployment dates

### Spreadsheet Structure

| Column | Field | Example |
|--------|-------|---------|
| A | `date` | September 25, 2025 |
| B | `team` | team_b |
| C | `brgy_prefix` | H030832 |
| D | (spacer) | |
| E-H | `stata command` | `replace users = "team_b" if brgy_prefix== "H030832"` |

### Rules
- One team per barangay (3–4 FOs per team)
- FM determines which barangays to deploy based on logistics, travel, and remaining cases
- The Stata command in columns E-H is pre-generated so the SRA can copy-paste directly into the do-file

---

## Step 2: Stata Processing (Case Generation)

**Who**: Senior Research Associate (SRA — Aubrey)
**Where**: Stata do-file run locally
**Input**: Multiple datasets (PSPS baseline, ICM selection, livelihoods participants)
**Output**: CSV file ready for SurveyCTO upload

### Data Sources

| Dataset | Path | Content |
|---------|------|---------|
| PSPS Wave 1 HH Survey | `$secure/4_data/2_survey/Household_linked_checked.dta` | Baseline household data (encrypted folder) |
| ICM Phase A Selected | `$icm_box/08_Analysis & Results/01_Data Analysis/Data/icm_hh_phaseA_selected_key_sharepii.dta` | Households selected for ICM study |
| Wave 1 Livelihoods Participants | `$BOX/.../wave1_livelihoods_participants.dta` | Treatment arm assignments |

### Filtering Logic

Cases are **excluded** if:
1. They belong to false-launch barangay prefixes (hardcoded list of ~20 prefixes)
2. `consent_agree != 1` (did not consent at baseline)
3. `consent_share_pii != 1` (did not consent to PII sharing)
4. They don't match ICM Phase A selected households (`_merge != 3`)
5. They don't match Wave 1 livelihoods participants (`_merge != 3`)
6. They are pilot households (hardcoded list of ~21 case IDs)

### Key Variables Generated

| Variable | Logic | Purpose |
|----------|-------|---------|
| `id` | = `caseid` | Unique case identifier for SurveyCTO |
| `label` | = `caseid + "-" + hh_resp_name` | Display label on FO's tablet |
| `users` | Set by team assignment (from Step 1) | Controls which team can see the case |
| `formids` | Treatment → both forms; Control → HH only | Controls which forms appear for the case |
| `hh_head` | = `calc_hh_mem_name1` | Head of household name |

### Form Assignment Logic (in Stata)

```stata
* Treatment households get BOTH forms (HH + ICM Business)
replace formids = "ICM_follow_up_launch_integrated,ICM_Business_linked_launch" if w1_liveli_treat ~= 0

* Control households get ONLY the HH survey
replace formids = "ICM_follow_up_launch_integrated" if w1_liveli_treat == 0 | w1_liveli_treat == .
```

### Output

- **CSV file**: Exported to `${icm_cases}/[batch_name].csv` (e.g., `pahseb_batch1.csv`)
- **Discord announcement text**: Generated by Stata's collapse + display loop:

```stata
preserve
gen displayc = users+" "+"-"+" " +barangay+","+" "+ municipality
collapse (first) displayc, by(brgy_prefix)
sort displayc
qui count
forvalues i = 1/`r(N)' {
    loc case = displayc[`i']
    di "`case'"
}
restore
```

This produces text like:
```
team_a - Libo-o, DINGLE
team_b - Guinacas, POTOTAN
team_c - Sipitan, TIGBAUAN
```

Which is then pasted into Discord `#general` channel.

---

## Step 3: SurveyCTO Server Upload

**Who**: SRA (Aubrey)
**Where**: SurveyCTO web console → Cases management
**What**: Upload the generated CSV as a cases dataset

### Process
1. Log into SurveyCTO server (`pspsicm` workspace)
2. Go to Cases → Upload/update cases
3. Upload the CSV file
4. Verify cases appear correctly
5. Announce on Discord (paste the Stata-generated team assignment text)

### After Upload
- FOs must **"Get Blank Form"** on their tablets to see new cases
- Cases become visible only to the team specified in the `users` column
- Each case shows the forms specified in `formids`

---

## Step 4: Field Data Collection

**Who**: Field Officers (FOs)
**Where**: SurveyCTO Collect app on tablets
**What**: Conduct interviews and submit forms

### FO Workflow
1. "Get Blank Form" → download latest forms and case list
2. Open assigned case from case list
3. Conduct interview following protocol
4. Save frequently during interview
5. Mark as finalized when complete
6. Submit when internet is available

### What FOs See on Their Tablet

- Case list filtered by their team name
- Each case shows: `label` (caseid-respondent name), `barangay`, `zone`
- Available forms based on `formids` (treatment HHs see 2 forms, control HHs see 1)

---

## Step 5: Auto-Closure via SurveyCTO Publishing

**What**: When a form is submitted, SurveyCTO evaluates the publishing formula and updates the cases dataset automatically.

### Publishing Formula

```
if(${consent_agree} = 1 and ${now_complete} = 1 and ${pull_icm_form_status} = 1,
   'Closed',
   if(${consent_agree} = 0,
      'Refused',
      ${users}))
```

### Logic Table

| `consent_agree` | `now_complete` | `pull_icm_form_status` | Result | Meaning |
|-----------------|---------------|----------------------|--------|---------|
| 1 (yes) | 1 (yes) | 1 (yes/complete) | `Closed` | Both HH and ICM surveys done → case disappears from tablet |
| 0 (no) | — | — | `Refused` | Respondent refused → case disappears |
| 1 (yes) | 0 (no) | — | `[team_x]` (unchanged) | HH survey not finished → case stays visible |
| 1 (yes) | 1 (yes) | 0 (no/pending) | `[team_x]` (unchanged) | HH done but ICM business not yet done → case stays visible |

### Important Implications

1. **For treatment households**: The case only closes when BOTH the HH survey AND the ICM Business module are complete (`pull_icm_form_status = 1`). This means if only the HH survey is done but the ICM participant hasn't been interviewed yet, the case remains open.

2. **For control households**: `pull_icm_form_status` should be 1 by default (no ICM form needed), so the case closes when HH survey is complete with consent.

3. **Partial completion**: If an FO completes the HH survey but the ICM participant is unavailable, the case stays assigned to the team. The FO (or another FO) must return to complete the ICM business module before the case will auto-close.

4. **No automatic non-response**: If a household is never interviewed, the case stays as `team_[x]` indefinitely. Non-response must be handled manually.

---

## Step 6: Data Download & Cleaning

**Who**: SRA (Aubrey)
**Where**: Stata
**What**: Download submitted data from SurveyCTO, clean, and prepare for analysis

### Process
1. Download data from SurveyCTO server (via API or manual export)
2. Import into Stata
3. Run cleaning scripts
4. Merge with baseline data for longitudinal analysis

---

## Step 7: High Frequency Checks (HFCs)

**Who**: SRA (Aubrey)
**Where**: Stata
**What**: Automated data quality checks run on submitted data

### Checks Include
- Duplicate submissions
- Survey duration outliers
- Consent inconsistencies
- Roster mismatches with baseline
- Income/consumption outliers
- GPS coordinate verification
- Don't Know / Refuse rates by enumerator
- Enumerator-specific patterns

### Feedback Loop
- Quality issues → SRA contacts FC → FC follows up with FO
- Serious issues may require case reopening (see case_status_rules.md)

---

## Bot Integration Points

The bot can connect to these data sources:

| Source | What Bot Can Read | How |
|--------|------------------|-----|
| **Assignment Spreadsheet** (Google Sheets) | Team assignments, deployment dates, brgy mappings | Google Sheets API |
| **Productivity Tracker** (Google Sheets) | Survey completion counts, FO productivity | Google Sheets API |
| **SurveyCTO Server** | Case statuses (Open/Closed/Refused), submission counts, form versions | SurveyCTO REST API |
| **Knowledge Base** (protocol docs) | Protocol rules, FAQs, troubleshooting | Local file / vector DB |

### What the Bot Can Automate

| Task | Current Manual Process | Bot Automation |
|------|----------------------|----------------|
| **Announce assignments** | SRA runs Stata, copies output, pastes to Discord | Bot reads assignment sheet → generates announcement |
| **Check case status** | SRA logs into SurveyCTO server manually | Bot queries SurveyCTO API → responds in Discord |
| **Form version check** | SRA announces manually | Bot monitors SurveyCTO → auto-announces updates |
| **Productivity updates** | SRA checks Google Sheet manually | Bot reads sheet → posts daily summary |
| **Answer protocol questions** | SRA reads Discord, types answer | Bot searches knowledge base → answers or escalates |
| **Reopen cases** | SRA manually edits cases dataset on server | ⚠️ Cannot automate — requires SRA action (bot can log the request and notify SRA) |

---

## File Paths Reference

> For SRA reference only. These should NOT be accessible to the bot.

| Path | Content | Access |
|------|---------|--------|
| `$secure` (encrypted) | Raw survey data with PII | Cryptomator-encrypted local drive |
| `$public` (Box) | HFC outputs, non-PII data | Box cloud storage |
| `$icm_box` (Box) | ICM study files, questionnaires, analysis data | Box cloud storage |
| `$icm_cases` (local) | Generated CSV files for SurveyCTO upload | Local encrypted drive |
| `$survey_data` | Cleaned survey datasets | Cryptomator-encrypted local drive |

---

## SurveyCTO Server Details

| Field | Value |
|-------|-------|
| Server name | `pspsicm` |
| Workspace URL | `https://pspsicm.surveycto.com` |
| Forms | `ICM_follow_up_launch_integrated` (HH), `ICM_Business_linked_launch` (ICM Business) |
| Cases dataset | Updated via CSV upload and auto-publishing |
| Training credentials | Username: `training` / Password: `training` |

> ⚠️ Production credentials should NEVER be stored in bot code or knowledge base documents.
> Use environment variables or a secrets manager.